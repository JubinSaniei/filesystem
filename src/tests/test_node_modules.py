import requests
import json
import time
import sys
import os

# Add the project root to the path so modules can be imported
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "../..")))
from src.utils.config import API_URL

def check_node_modules_ignore():
    """Test if node_modules directories are being ignored"""
    print("Testing if node_modules directories are being ignored correctly...")
    
    # Get the current ignore patterns
    ignore_response = requests.get(f"{API_URL}/ignore_patterns")
    ignore_data = ignore_response.json()
    
    print(f"Ignore patterns status: {ignore_data.get('status')}")
    print(f"Total patterns: {ignore_data.get('pattern_count', 0)}")
    
    # Check for node_modules patterns
    patterns = ignore_data.get('patterns', [])
    node_patterns = [p for p in patterns if 'node_modules' in p]
    print(f"Node modules patterns: {len(node_patterns)}")
    for pattern in node_patterns:
        print(f"- {pattern}")
    
    # Search for node_modules
    print("\nSearching for node_modules directories...")
    search_response = requests.post(
        f"{API_URL}/search_files",
        json={
            "path": "/mnt/c/Sandboxes/CodeGen",
            "pattern": "node_modules",
            "excludePatterns": [],
            "pagination": {
                "offset": 0,
                "limit": 10
            },
            "timeout_seconds": 30
        }
    )
    
    result = search_response.json()
    total = result.get('total', 0)
    
    print(f"Found {total} node_modules directories/files")
    if total > 0:
        items = result.get('items', [])
        print("Sample results:")
        for item in items[:5]:
            print(f"- {item.get('path')} ({item.get('type')})")
    else:
        print("No node_modules found - ignore patterns working correctly!")
    
    # Index a directory and wait for it to complete
    print("\nIndexing test directory...")
    index_response = requests.post(
        f"{API_URL}/index_directory",
        json={"path": "/mnt/c/Sandboxes/CodeGen/vscodeExt"}
    )
    
    if index_response.status_code == 200:
        index_data = index_response.json()
        print(f"Indexing status: {index_data.get('status')}")
        print(f"Files indexed: {index_data.get('file_count')}")
        print(f"Message: {index_data.get('message')}")
        
        # Check metadata status
        time.sleep(2)  # Wait a bit for indexing to complete
        metadata_response = requests.get(f"{API_URL}/metadata_status")
        metadata_data = metadata_response.json()
        print(f"Metadata status: {metadata_data.get('status')}")
        print(f"Total indexed files: {metadata_data.get('indexed_files')}")
    else:
        print(f"Indexing failed: {index_response.status_code} - {index_response.text}")

if __name__ == "__main__":
    check_node_modules_ignore()